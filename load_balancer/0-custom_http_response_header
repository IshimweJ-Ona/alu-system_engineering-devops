#!/usr/bin/env bash
# Configures Nginx to include a custom header X-Served-By with the server hostname

# Exit immediately if a command fails
set -e

# Install Nginx
apt-get update -y
apt-get install -y nginx

# Get current hostname
HOSTNAME=$(hostname)

# Remove any existing X-Served-By headers to avoid duplicates
sed -i '/add_header X-Served-By/d' /etc/nginx/sites-available/default

# Add the header inside the server block
sed -i "/server_name _;/a \        add_header X-Served-By \"$HOSTNAME\";" /etc/nginx/sites-available/default

# Test Nginx configuration
nginx -t || { echo "Nginx configuration test failed"; exit 1; }

# Restart Nginx (compatible with older Ubuntu versions)
service nginx restart
